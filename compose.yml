services:
  yew_front:
    image: ghcr.io/juliog922/yew_front:latest
    command: trunk serve --release --port 8092 --address 0.0.0.0 --no-autoreload
    networks:
      - app_network
    deploy:
      update_config:
        order: start-first

  actix_api:
    image: ghcr.io/juliog922/actix_api:latest
    command: cargo run --bin server --release
    environment:
      - API_PORT=8080
      - API_HOST=0.0.0.0
      - RUST_LOG=info
    depends_on:
      - surrealdb
    networks:
      - app_network
    deploy:
      update_config:
        order: start-first

  nginx:
    image: ghcr.io/juliog922/nginx:latest
    ports:
      - "8091:80"
    networks:
      - app_network
    depends_on:
      - actix_api
      - yew_front
    deploy:
      update_config:
        order: start-first

  surrealdb:
    image: surrealdb/surrealdb:latest
    user: root
    ports:
      - 8000:8000
    entrypoint: 
      - /surreal 
      - start 
      - --log
      - info
      - surrealkv://var/lib/surrealdb/data
    volumes:
      - db-data:/var/lib/surrealdb/data
    networks:
      - app_network
    healthcheck:
      test: ["CMD","/surreal", "is-ready", "--conn", "http://localhost:8000"]
      interval: 15s
      retries: 5
      start_period: 30s
      timeout: 10s

volumes:
  db-data:

networks:
  app_network:
    driver: overlay
